extends Node2D

var phone_popup_triggered: bool = false
var items_popup_active: bool = false
var phone_dialogue_completed: bool = false  # ğŸ†• phone å¯¹è¯æ˜¯å¦å®Œæˆ
var earphone_dialogue_completed: bool = false  # ğŸ†• earphone å¯¹è¯æ˜¯å¦å®Œæˆ

func _ready():
	print("\nğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ")
	print("ğŸŒŸ ä¸»åœºæ™¯ _ready() æ‰§è¡Œ")
	print("ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ")
	
	print("\nğŸ“‹ åœºæ™¯æ ‘ç»“æ„:")
	print_tree_recursive(self, 0)
	
	print("\nğŸ” æŸ¥æ‰¾èƒŒæ™¯èŠ‚ç‚¹:")
	var far_bg = get_node_or_null("FarBackground")
	if far_bg:
		print("  âœ“ æ‰¾åˆ° FarBackground")
		print("    è„šæœ¬: " + str(far_bg.get_script()))
		print("    is_processing: " + str(far_bg.is_processing()))
		print("    is_node_ready: " + str(far_bg.is_node_ready()))
		print("    å­èŠ‚ç‚¹æ•°: " + str(far_bg.get_child_count()))
	else:
		print("  âŒ æ‰¾ä¸åˆ° FarBackgroundï¼")
	
	var mid_bg = get_node_or_null("MidBackground")
	if mid_bg:
		print("  âœ“ æ‰¾åˆ° MidBackground")
	else:
		print("  âŒ æ‰¾ä¸åˆ° MidBackgroundï¼")
	
	var near_bg = get_node_or_null("NearBackground")
	if near_bg:
		print("  âœ“ æ‰¾åˆ° NearBackground")
	else:
		print("  âŒ æ‰¾ä¸åˆ° NearBackgroundï¼")
	
	print("\nğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ\n")
	
	# 5ç§’ååŒæ—¶è§¦å‘ä¸¤ä¸ªç‰©å“å¼¹å‡º
	await get_tree().create_timer(5.0).timeout
	trigger_items_popup()

func print_tree_recursive(node: Node, level: int):
	var indent = ""
	for i in range(level):
		indent += "  "
	
	var script_info = ""
	if node.get_script():
		script_info = " [è„šæœ¬: " + str(node.get_script().resource_path) + "]"
	
	print(indent + "â”œâ”€ " + node.name + " (" + node.get_class() + ")" + script_info)
	
	for child in node.get_children():
		print_tree_recursive(child, level + 1)

func trigger_items_popup():
	if phone_popup_triggered:
		return
	
	phone_popup_triggered = true
	items_popup_active = true
	phone_dialogue_completed = false
	earphone_dialogue_completed = false
	
	print("\nğŸ“±ğŸ§ è§¦å‘ç‰©å“å¼¹å‡ºåŠ¨ç”»...")
	
	var phone = find_node_recursive(self, "phone")
	var earphone = find_node_recursive(self, "earphone")
	
	print("ğŸ” æŸ¥æ‰¾ç»“æœ:")
	print("  phone: " + (str(phone.get_path()) if phone else "æœªæ‰¾åˆ°"))
	print("  earphone: " + (str(earphone.get_path()) if earphone else "æœªæ‰¾åˆ°"))
	
	if phone == null:
		print("âŒ æ‰¾ä¸åˆ° phone èŠ‚ç‚¹ï¼")
	
	if earphone == null:
		print("âŒ æ‰¾ä¸åˆ° earphone èŠ‚ç‚¹ï¼")
		return
	
	dim_backgrounds()
	
	if phone and phone.has_method("show_popup"):
		phone.show_popup()
	
	if earphone and earphone.has_method("show_popup"):
		earphone.show_popup()

func find_node_recursive(node: Node, node_name: String) -> Node:
	if node.name == node_name:
		return node
	
	for child in node.get_children():
		var result = find_node_recursive(child, node_name)
		if result:
			return result
	
	return null

func dim_backgrounds():
	print("ğŸŒ‘ é™ä½èƒŒæ™¯é¥±å’Œåº¦å’Œé€æ˜åº¦...")
	
	var backgrounds = [
		get_node_or_null("FarBackground"),
		get_node_or_null("MidBackground"),
		get_node_or_null("NearBackground")
	]
	
	for bg in backgrounds:
		if bg:
			var tween = create_tween()
			tween.set_parallel(true)
			tween.tween_property(bg, "modulate:a", 0.5, 0.5)
			tween.tween_property(bg, "modulate", Color(0.5, 0.5, 0.5, 0.5), 0.5)

# ğŸ”¥ åªæœ‰ä¸¤ä¸ªå¯¹è¯éƒ½å®Œæˆæ‰æ¢å¤èƒŒæ™¯
func restore_backgrounds():
	print("\nğŸ” æ£€æŸ¥èƒŒæ™¯æ¢å¤æ¡ä»¶:")
	print("  phone å¯¹è¯å®Œæˆ: " + str(phone_dialogue_completed))
	print("  earphone å¯¹è¯å®Œæˆ: " + str(earphone_dialogue_completed))
	
	# ğŸ”¥ å…³é”®ï¼šå¿…é¡»ä¸¤ä¸ªéƒ½å®Œæˆæ‰æ¢å¤
	if phone_dialogue_completed and earphone_dialogue_completed:
		print("âœ“ ä¸¤ä¸ªå¯¹è¯éƒ½å·²å®Œæˆï¼Œæ¢å¤èƒŒæ™¯ï¼")
		
		var backgrounds = [
			get_node_or_null("FarBackground"),
			get_node_or_null("MidBackground"),
			get_node_or_null("NearBackground")
		]
		
		for bg in backgrounds:
			if bg:
				var tween = create_tween()
				tween.tween_property(bg, "modulate", Color(1.0, 1.0, 1.0, 1.0), 0.5)
		
		items_popup_active = false
	else:
		print("â³ ç­‰å¾…å¦ä¸€ä¸ªç‰©å“çš„å¯¹è¯å®Œæˆ...")

# ğŸ†• æ ‡è®°æŸä¸ªç‰©å“çš„å¯¹è¯å·²å®Œæˆ
func mark_dialogue_completed(item_name: String):
	print("\nğŸ“ æ ‡è®°å¯¹è¯å®Œæˆ: " + item_name)
	
	if item_name == "phone":
		phone_dialogue_completed = true
	elif item_name == "earphone":
		earphone_dialogue_completed = true
	
	# å°è¯•æ¢å¤èƒŒæ™¯
	restore_backgrounds()

func check_all_items_hidden():
	var phone = find_node_recursive(self, "phone")
	var earphone = find_node_recursive(self, "earphone")
	
	var phone_hidden = phone == null or not phone.is_popup_visible
	var earphone_hidden = earphone == null or not earphone.is_popup_visible
	
	print("ğŸ” æ£€æŸ¥ç‰©å“çŠ¶æ€:")
	print("  phone éšè—: " + str(phone_hidden))
	print("  earphone éšè—: " + str(earphone_hidden))
	
	if phone_hidden and earphone_hidden:
		print("âœ“ æ‰€æœ‰ç‰©å“å·²éšè—")
