extends SceneBase

# ==================== Hover 状态管理 ====================
var is_in_hover_preview = false
var hover_preview_segments: Array = []
var hover_current_segment = 0
var hovered_choice_label: Label = null
var hovered_choice_image: Sprite2D = null
var hover_typing_finished = false
var showing_transition = false
var choice_dialogue_finished = false

# ==================== 初始化场景数据 ====================
func _init():
	scene_name = "seaside"
	
	# ==================== V1 对话数据 ====================
	var v1_dialogues: Array[String] = [
		"""You’ve heard about this seaside fireworks festival for a long time.""",

		"""As someone who grew up in a coastal city, the sea always brings you the simplest comfort.
		
You listen to the waves crashing against the rocks repeatedly, feeling a rare sense of calm. """,

		"""You like staring at the waves, their shapes, heights, and also their force are never the same. """,

		"""You notice the crowd walking in the same direction.
		
That’s the direction for fireworks."""
	]

	# ==================== V2 对话数据 ====================
	var v2_dialogues: Array[String] = [
		"""This is your second visit to the seaside tonight. The sky is darker than before naturally.
		
Later hours mean stronger winds and colder air, so you pull your coat tighter around you.""",

		"""There are no fireworks now, and the crowd has thinned.
		
People are strolling along the coast, leaning on each other, sharing warmth, breath, and the same song in their earphones.

You can’t help but wonder, what kind of song suits this view so perfectly?""",

		""""Your eyes follow a young couple. They’re shivering in the cold but each holding an ice cream.
	
You are thinking about:"""
	]
	
	# ==================== V3 对话数据 ====================
	var v3_dialogues: Array[String] = [
		"""This is your third time at the seaside tonight. It’s very late now and hardly anyone’s around. 
		
You pick a familiar spot on the sand and sit down again, staring at the waves for what feels like the hundred-and-first time.""",

		"""You wonder where do the waves come from, and where do they go?

Can they travel the world endlessly? You once discussed with a friend what you’d like to become in another life. Your friend wanted to be a bird. “What a boring choice.” You thought. You wanted to be a wave.""",

		"""People often ask why you love the sea so much, but you never have a clear answer.""",
		
		"""Maybe it’s because you’ve learned how to breathe and how to steady your heartbeat following the rhythm of the waves.

Sometimes you feel like throwing yourself into the sea to let it wash away all the scents of the reality.

The cold, thick seawater rushes toward you and in that trembling sensation, you feel alive.""",

		"""You think life should be turbulent like this, and yet, maybe it shouldn’t be. 

Do you prefer a peaceful but boring life, or a turbulent yet inspiring one?"""
	]
	
	dialogue_data_versions = [v1_dialogues, v2_dialogues, v3_dialogues]
	
	# ==================== V1 选择数据（小选择）====================
	var v1_choices = [
		{
			"text": "Fireworks?",
			"effects": {"O1": 1},
			"next_dialogue": [
				"""Moments like this don’t come very often, and you’ve always loved watching fireworks bloom in the sky.

It’s a collective experience and the joy of the crowd amplifies your own happiness.""",

				"""Boom!

A firework bursts open.""",

				"""While everyone’s gaze is fixed on the sky, you find yourself watching everyone in the crowd instead.

Some are holding hands while smiling blissfully and some are standing alone but still beaming with quiet joy. As you watch everyone enjoying this beautiful moment together, you feel a spark of hope ignite inside you like fireworks themselves.

Maybe someday, you’ll also be able to immerse yourself fully in moments like this, like everyone else.""",

				"""The fireworks end quickly,
and the night deepens."""
			]
		},
		{
			"text": "Just sitting",
			"effects": {"P1": 1},
			"next_dialogue": [
				"""Joining the crowd is the last thing you want to do. """,

				"""You decide to share this quiet moment with the sea instead.

You open your memo recorder and start summarizing today’s story, then move on to write tomorrow’s plan...

Wait, tomorrow’s plan?."""
			]
		}
	]
	
	# ==================== V2 选择数据（小选择）====================
	var v2_choices = [
		{
			"text": "I need to try",
			"effects": {"O1": 1},
			"next_dialogue": [
				"""I definitely need to try that ice cream.""",

				"""You pick yogurt and caramel cookie flavours, proudly to claim yourself as an expert at flavour pairing. 

The portions are generous, actually almost too much. Probably the weather is too cold for ice cream, after a few bites you are trembling.""",

				""" But you can’t stand wasting food,
so you still finish it all."""
			]
		},
		{
			"text": "No way",
			"effects": {"P1": 1},
			"next_dialogue": [
				"""Ice cream in this cold? No way… """,
				
				"""You keep walking along the coast and keep thinking as you go. You really enjoy this kind of time with your carefully curated playlist in your ears and your mind wandering freely.

You question yourself: maybe I just need more smaller breaks like this? Like a gear that needs oiling after constant work, maybe you do need that as well."""

			]
		}
	]
	
	# ==================== V3 选择数据（小选择）====================
	var v3_choices = [
		{
			"text": "Peaceful",
			"effects": {"P1": 1},
			"next_dialogue": [
				"""You choose stillness over change. """,

				"""The silence brings comfort, yet also an ache of emptiness, as if something essential has been left untouched.

You feel safe here, but the stillness begins to weigh on you."""
			]
		},
		{
			"text": "Insipring",
			"effects": {"O1": 1},
			"next_dialogue": [
				"""You embrace the storm that comes with passion.""",

				"""A life filled with motion and color. That’s the life full of passion, chaos, and sudden turns.

Every moment burns bright, but peace is fleeting, leaving you breathless in its wake.

You can feel alive, yet constantly on the edge of losing balance."""
			]
		}
	]
	
	choice_data_versions = [v1_choices, v2_choices, v3_choices]

# ==================== 选择后的过渡对话 ====================
var v1_transition_dialogue: Array[String] = [
	"""Time passes anyway.

You used to think that it is so interminable and exasperating to watch the hand turn for five minutes on a clock face. 

But now you’ve been sitting by the sea for much longer than that.

You wrap up and about to leave."""
]

var v2_transition_dialogue: Array[String] = [
	"""You wander without direction, just moving for the sake of moving.

When you finally look up, you’ve arrived the underground station and decide to go to..."""
]

var v3_transition_dialogue: Array[String] = [
	"""No matter which one you prefer, the sea is always there.

When others say they’ve “seen enough mountains and rivers,” you can’t really relate.

Mountains, skies, and the sea. How could you feel tired about looking at them. There’s always a flash of newness you find precious.

You can’t answer many of your questions to yourself, so you let the sea hear your thoughts and then you stand up.
"""
]

# ==================== 大选择数据 ====================
# V1的大选择：4个场景
var v1_big_choices = [
	{
		"text": "Return to
the seaside?",
		"effects": {},
		"next_scene": "seaside"
	},
	{
		"text": "Maybe visit a friend?",
		"effects": {},
		"next_scene": "friend_house"
	},
	{
		"text": "Maybe go to
the bar?",
		"effects": {},
		"next_scene": "yaki_bar"
	},
	{
		"text": "Facetime with parents",
		"effects": {},
		"next_scene": "parents"
	}
]

# V2的大选择：4个场景
var v2_big_choices = [
	{
		"text": "Return to
the seaside?",
		"effects": {},
		"next_scene": "seaside"
	},
	{
		"text": "Maybe visit a friend?",
		"effects": {},
		"next_scene": "friend_house"
	},
	{
		"text": "Maybe go to
the bar?",
		"effects": {},
		"next_scene": "yaki_bar"
	},
	{
		"text": "Facetime with parents",
		"effects": {},
		"next_scene": "parents"
	}
]

# V3的大选择：2个选项（含ending）
var v3_big_choices = [
	{
		"text": "Go back to apartment?",
		"effects": {},
		"next_scene": "apartment"
	},
	{
		"text": "Walk into the sea",
		"effects": {},
		"next_scene": "ending",
		"force_ending": "ending_04" 
	}
]

# ==================== 图片路径映射 ====================
func get_choice_image_path(choice_text: String) -> String:
	"""返回选项图片路径"""
	var text_lower = choice_text.to_lower()
	
	var image_map = {
		# V1 小选择
		"fireworks": "res://assets/choices/seaside/seaside_fireworks.png",
		"just sitting": "res://assets/choices/seaside/seaside_journal.png",
		
		# V2 小选择
		"need to try": "res://assets/choices/seaside/seaside_icecream.png",
		"no way": "res://assets/choices/seaside/seaside_noway.png",
		
		# V3 小选择
		"peaceful": "res://assets/choices/seaside/seaside_peaceful.png",
		"inspiring": "res://assets/choices/seaside/seaside_inspiring.png",
		
		# 大选择（共享）
		"sleep": "res://opening/apartment_opening.png",
		"parents": "res://opening/parents_opening.png",
		"facetime": "res://opening/parents_opening.png",
		"friend": "res://opening/friend_opening.png",
		"bar": "res://opening/bar_opening.png",
		"seaside": "res://opening/seaside_opening.png",
	}
	
	for key in image_map:
		if key in text_lower:
			return image_map[key]
	
	return "res://icon.png"

# ==================== 覆盖：显示选择 ====================
func _show_choices():
	"""显示选择并调整图片大小"""
	
	# 判断是否为大选择（showing_transition = true 时显示的是大选择）
	var is_big_choice = showing_transition
	
	# 调用父类显示
	super._show_choices()
	
	# ========== 动态调整图片大小 ==========
	var target_size_px = 0.0
	
	if is_big_choice:
		# 大选择：小一点
		target_size_px = 350.0
	else:
		# 小选择：大一点
		target_size_px = 300.0
	
	# 应用缩放
	for node in choice_nodes:
		if node.visible:
			var img = node.get_node("ChoiceImage")
			if img and img.texture:
				var original_size = img.texture.get_size()
				
				if original_size.x > 0:
					var scale_factor = target_size_px / original_size.x
					img.scale = Vector2(scale_factor, scale_factor)
	# ========== 缩放结束 ==========

# ==================== 选择点击处理（【重要修复】） ====================
func _on_choice_input_event(viewport, event: InputEvent, shape_idx, choice_data_item: Dictionary):
	if event is InputEventMouseButton and event.button_index == MOUSE_BUTTON_LEFT and event.is_pressed():
		
		if choice_state != ChoiceState.IDLE:
			print("[DEBUG] Choice click ignored, state: %s" % choice_state)
			return
		
		get_viewport().set_input_as_handled()
		
		# ✅ 递增计数
		GM.choice_count += 1
		print("[%s V%d] Big Choice #%d" % [scene_name.to_upper(), current_version, GM.choice_count])
		
		# 应用效果
		if choice_data_item.has("effects"):
			for stat in choice_data_item.effects:
				if GM.stats.has(stat):
					GM.stats[stat] += choice_data_item.effects[stat]
		
		choice_container.visible = false
		choice_state = ChoiceState.CHOICE_MADE
		
		var next_scene = choice_data_item.get("next_scene", "")
		
		# ✅ 【关键】检查是否是第5次大选择
		if GM.choice_count >= 5:
			print("→ [5TH BIG CHOICE] Triggering ending!")
			
			var force_ending = choice_data_item.get("force_ending", "")
			if force_ending != "":
				GM.trigger_ending(force_ending)
			else:
				GM.trigger_ending()
			
			return
			
		# 处理场景跳转（大选择直接跳转）
		if next_scene != "":
			print("→ Jumping to scene: ", next_scene)
			GM.change_scene(next_scene)
			return
		
		# ========== 小选择：显示过渡对话 ==========
		print("\n[Small Choice Selected] Showing transition dialogue...")
		
		showing_transition = true
		choice_dialogue_finished = false
		
		# 根据版本选择过渡对话
		if current_version == 1:
			dialogue_segments = v1_transition_dialogue
		elif current_version == 2:
			dialogue_segments = v2_transition_dialogue
		elif current_version == 3:
			dialogue_segments = v3_transition_dialogue
		
		current_segment_index = 0
		is_dialogue_finished = false
		dialogue_panel.visible = true
		
		print("[TRANSITION] Calling _start_next_segment()...")
		_start_next_segment()

# ==================== 对话完成处理 ====================
func _on_dialogue_finished():
	"""对话全部完成后的处理"""
	is_dialogue_finished = true
	
	print("\n========== DIALOGUE FINISHED ==========")
	print("  Version: %d" % current_version)
	print("  choice_count: %d" % GM.choice_count)
	print("  showing_transition: %s" % showing_transition)
	print("=======================================\n")
	
	# ========== 过渡对话完成，显示大选择 ==========
	if showing_transition:
		print("→ Transition finished, showing big choices")
		showing_transition = false
		
		await get_tree().create_timer(0.5).timeout
		
		# 根据版本选择对应的大选择
		if current_version == 1:
			choice_data = v1_big_choices
			print("[Big Choice] Loading V1 big choices (5 options)")
		elif current_version == 2:
			choice_data = v2_big_choices
			print("[Big Choice] Loading V2 big choices (4 options)")
		elif current_version == 3:
			choice_data = v3_big_choices
			print("[Big Choice] Loading V3 big choices (5 options with ending)")
		
		# 标记这次是大选择
		showing_transition = true  # 用于 _show_choices 判断图片大小
		choice_state = ChoiceState.IDLE
		
		print("[Big Choice] Calling _show_choices()...")
		_show_choices()
		showing_transition = false  # 显示完毕后重置
		print("[Big Choice] _show_choices() returned\n")
		return
	
	# ========== 开场对话完成，显示小选择 ==========
	print("→ Opening dialogue finished, showing small choices")
	_show_choices()

# ==================== 覆盖 Hover 处理 ====================
func _on_choice_mouse_entered(choice_label: Label, choice_image: Sprite2D, choice_data_item: Dictionary):
	"""鼠标悬停到选择上（支持完整对话预览）"""
	if choice_state != ChoiceState.IDLE:
		return
	
	# 保存hover的节点引用
	hovered_choice_label = choice_label
	hovered_choice_image = choice_image
	
	# 显示label
	var tween = create_tween()
	tween.tween_property(choice_label, "modulate:a", 1.0, 0.3)
	
	# 图片变暗
	choice_image.self_modulate = Color(0.6, 0.6, 0.6)
	
	# 准备完整的预览对话
	var next_dialogue = choice_data_item.get("next_dialogue", "")
	
	# 只有真正有内容时才进入预览模式
	if next_dialogue is Array and next_dialogue.size() > 0:
		hover_preview_segments = next_dialogue.duplicate()
	elif next_dialogue is String and next_dialogue != "":
		hover_preview_segments = [next_dialogue]
	else:
		hover_preview_segments = []
	
	# 只有当有预览内容时，才进入预览模式
	if hover_preview_segments.size() > 0:
		choice_state = ChoiceState.HOVER_ACTIVE
		is_in_hover_preview = true
		hover_typing_finished = false
		
		# 显示第一段
		hover_current_segment = 0
		hover_desc_container.visible = true
		hover_desc_text.start_typing(hover_preview_segments[0])
		
		print("[Hover Preview] Started: %d segments" % hover_preview_segments.size())
	else:
		# 没有预览内容（如大选择），只显示视觉效果
		print("[Hover] No preview content, simple hover only")

func _on_choice_mouse_exited(choice_label: Label, choice_image: Sprite2D):
	"""鼠标离开选择（只在未预览时生效）"""
	# 只在非预览状态下隐藏
	if not is_in_hover_preview:
		# 隐藏label
		var tween = create_tween()
		tween.tween_property(choice_label, "modulate:a", 0.0, 0.3)
		
		# 图片恢复
		choice_image.self_modulate = Color(1.0, 1.0, 1.0)
		
		# 隐藏描述（如果有的话）
		if hover_desc_container.visible:
			hover_desc_container.visible = false
			hover_desc_text.stop_typing()
		
		# 清理引用
		hovered_choice_label = null
		hovered_choice_image = null

func _input(event):
	if event is InputEventMouseButton and event.button_index == MOUSE_BUTTON_LEFT and event.is_pressed():
		
		# ========== 处理hover预览中的点击 ==========
		if is_in_hover_preview:
			get_viewport().set_input_as_handled()
			
			if not hover_typing_finished:
				# 第一次点击：完成当前段落的打字
				hover_desc_text.finish_typing()
				hover_typing_finished = true
				print("[Hover Preview] Finished typing segment %d" % (hover_current_segment + 1))
			
			# 检查是否需要翻页
			if hover_typing_finished:
				# 打字已完成，翻到下一页
				hover_current_segment += 1
				
				if hover_current_segment < hover_preview_segments.size():
					# 还有下一页
					print("[Hover Preview] Page %d/%d" % [hover_current_segment + 1, hover_preview_segments.size()])
					hover_typing_finished = false
					hover_desc_text.start_typing(hover_preview_segments[hover_current_segment])
				else:
					# 预览完成，结束hover
					print("[Hover Preview] Completed")
					_end_hover_preview()
			
			return
		
		# 如果choice_container可见，不处理对话点击
		if choice_container.visible:
			return
		
		get_viewport().set_input_as_handled()
		
		# 处理正常的对话点击
		if dialogue_panel.visible:
			if is_typing:
				print("[Input] Finishing typing...")
				_finish_typing()
			elif not is_typing and not is_dialogue_finished:
				print("[Input] Next segment (current: %d/%d)" % [current_segment_index, dialogue_segments.size()])
				_start_next_segment()
			elif is_dialogue_finished:
				print("[Input] Dialogue finished, calling super._input()...")
				super._input(event)

func _end_hover_preview():
	"""结束hover预览，恢复可点击状态"""
	is_in_hover_preview = false
	hover_preview_segments = []
	hover_current_segment = 0
	hover_typing_finished = false
	
	# 恢复状态
	choice_state = ChoiceState.IDLE
	
	# 隐藏hover描述
	hover_desc_container.visible = false
	hover_desc_text.stop_typing()
	
	# 恢复label和图片状态
	if hovered_choice_label:
		var tween = create_tween()
		tween.tween_property(hovered_choice_label, "modulate:a", 0.0, 0.3)
	
	if hovered_choice_image:
		hovered_choice_image.self_modulate = Color(1.0, 1.0, 1.0)
	
	hovered_choice_label = null
	hovered_choice_image = null
	
	print("[Hover Preview] Ended, choices now clickable")

func _start_next_segment():
	"""开始下一段对话（添加调试）"""
	print("\n[_start_next_segment] Called")
	print("  current_segment_index: %d" % current_segment_index)
	print("  dialogue_segments.size(): %d" % dialogue_segments.size())
	
	if current_segment_index >= dialogue_segments.size():
		print("  → All segments finished, calling _on_dialogue_finished()")
		_on_dialogue_finished()
		return
	
	print("  → Starting segment %d: '%s...'" % [current_segment_index, dialogue_segments[current_segment_index].substr(0, 50)])
	
	# 调用父类
	super._start_next_segment()
	
	print("[_start_next_segment] Returned\n")

	# ========== 【添加宝丽来照片效果】 ==========
	randomize()
	
	for i in range(choice_nodes.size()):
		var node = choice_nodes[i]
		if node.visible:
			# 随机旋转
			node.rotation_degrees = randf_range(-10.0, 10.0)
			
			# 位置微调（模拟随意摆放）
			node.position += Vector2(
				randf_range(-20, 20),  # X轴微调
				randf_range(-20, 20)   # Y轴微调
			)
			
			# Z轴深度感（可选）
			node.z_index = randi() % 3  # 0, 1, 或 2
			
			print("[Polaroid] Choice%d: rotation=%.1f°, z_index=%d" % [i+1, node.rotation_degrees, node.z_index])
	choice_state = ChoiceState.IDLE
	# ========== 【宝丽来效果结束】 ==========
